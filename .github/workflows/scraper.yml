name: Global Media Scraper

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  # مصفوفة المواقع (Strategy Matrix)
  # دي حركة ذكية بتخلينا نكتب الكود مرة واحدة وهو يكرره لكل موقع لوحده
  scrape:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # عشان لو موقع فشل الباقي يكمل عادي
      matrix:
        scraper: [
          "akoam_movies_scraper.py", "akoam_series_scraper.py",
          "mycima_movies_scraper.py", "mycima_series_scraper.py",
          "fushaar_movies_scraper.py", "fushaar_series_scraper.py",
          "egibest_movies_scraper.py", "egibest_series_scraper.py",
          "laroza_movies_scraper.py", "laroza_series_scraper.py"
          # "123movies_movies_scraper.py", "123movies_series_scraper.py"
        ]
    timeout-minutes: 120 # ساعتين كفاية جداً لكل سكريبت لوحده
    
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: |
          pip install playwright requests beautifulsoup4
          python -m playwright install chromium
      - name: Run Scraper
        run: python ${{ matrix.scraper }} || true
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # بنسمي الأرتيفاكت باسم السكريبت عشان ميتلخبطوش
          name: data-${{ strategy.job-index }}
          path: "*.json"

  # مهمة التجميع والرفع (تنتظر كل اللي فوق يخلصوا)
  merge_and_push:
    runs-on: ubuntu-latest
    needs: scrape
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Run Main Merger
        run: python main.py
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # محاولة الرفع مع التكرار في حالة الفشل
          for i in {1..5}; do
            git fetch origin main
            git add all_data.json
            git commit -m "Update DB: $(date +'%Y-%m-%d %H:%M')" || exit 0
            
            # عمل Rebase لسحب أي تغييرات حصلت في الـ 10 ثواني اللي فاتوا
            if git pull origin main --rebase -X ours && git push origin main; then
              echo "✅ تم الرفع بنجاح!"
              exit 0
            else
              echo "⚠️ فشل الرفع، جاري المحاولة مرة أخرى رقم $i..."
              sleep 5 # انتظر 5 ثواني قبل المحاولة الجاية
            fi
          done
          echo "❌ فشل الرفع بعد 5 محاولات."
          exit 1
