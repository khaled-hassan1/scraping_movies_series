name: Global Media Scraper

on:
  schedule:
    - cron: '0 0 * * 0' # تشغيل تلقائي كل أحد
  workflow_dispatch: # تشغيل يدوي

jobs:
  scrape:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scraper: [
          "akoam_movies_scraper.py", "akoam_series_scraper.py",
          "mycima_movies_scraper.py", "mycima_series_scraper.py",
          "fushaar_movies_scraper.py", "fushaar_series_scraper.py",
          "egibest_movies_scraper.py", "egibest_series_scraper.py",
          "laroza_movies_scraper.py", "laroza_series_scraper.py"
          # "123movies_movies_scraper.py", "123movies_series_scraper.py"
        ]
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: |
          pip install playwright requests beautifulsoup4
          python -m playwright install chromium
      - name: Run Scraper
        run: python ${{ matrix.scraper }} || true
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ strategy.job-index }}
          path: "*.json"

  merge_and_push:
    runs-on: ubuntu-latest
    needs: scrape
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true # تفعيل دعم الملفات الكبيرة

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Run Main Merger
        run: python main.py

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # إضافة الملف الأساسي ومجلد التقسيمات الجديد
          git add all_data.json db/
          
          # الالتزام بالتغييرات
          git commit -m "Update DB & Pages: $(date +'%Y-%m-%d %H:%M')" || exit 0
          
          # محاولة الرفع مع إعادة المحاولة في حالة وجود تعارض (Rebase)
          for i in {1..5}; do
            git pull origin main --rebase -X ours
            if git push origin main; then
              echo "✅ تم الرفع بنجاح!"
              exit 0
            fi
            echo "⚠️ فشل الرفع، محاولة مجددة بعد 5 ثواني..."
            sleep 5
          done
          exit 1
